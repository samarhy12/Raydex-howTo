{% extends "base.html" %} {% block title %}Create Post - Raydex Admin{% endblock
%} {% block content %}
<div class="min-h-screen py-12 pb-20">
  <div class="max-w-4xl mx-auto px-6 md:px-8">
    <header class="pb-8 mb-12 border-b-2 border-border">
      <h1 class="font-serif text-4xl md:text-5xl font-bold text-ink mb-2">
        Create New Post
      </h1>
      <p class="text-base text-ink-soft">
        Write and publish a new how-to guide
      </p>
    </header>
    <div class="bg-surface border border-border rounded-xl p-8">
      <form id="createForm" class="space-y-6">
        <div>
          <label class="block text-sm font-medium text-ink mb-2">Title</label
          ><input
            type="text"
            id="title"
            required
            class="w-full px-4 py-3.5 border border-border rounded-lg"
            placeholder="How to..."
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-ink mb-2"
            >Subtitle (optional)</label
          ><input
            type="text"
            id="subtitle"
            class="w-full px-4 py-3.5 border border-border rounded-lg"
            placeholder="A brief description"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-ink mb-2"
            >Content Blocks</label
          >
          <div id="contentBlocks"></div>
          <div class="flex gap-2 mt-4">
            <button
              type="button"
              onclick="addTextBlock()"
              class="px-4 py-2 border border-border rounded-lg text-sm hover:border-accent"
            >
              + Text</button
            ><button
              type="button"
              onclick="addImageBlock()"
              class="px-4 py-2 border border-border rounded-lg text-sm hover:border-accent"
            >
              + Image
            </button>
          </div>
        </div>
        <button
          type="submit"
          id="submitBtn"
          class="w-full py-4 bg-accent text-surface rounded-lg font-medium hover:bg-accent-soft"
        >
          <span id="submitText">Publish Post</span
          ><span id="loadingText" class="hidden">Publishing...</span>
        </button>
      </form>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  let blockCount = 0;

  // Check authentication on page load
  document.addEventListener("DOMContentLoaded", () => {
    const token = localStorage.getItem("token");
    const userStr = localStorage.getItem("user");

    if (!token || !userStr) {
      window.location.href = "/login";
      return;
    }

    try {
      const user = JSON.parse(userStr);
      if (user.role !== "admin") {
        window.location.href = "/dashboard";
        return;
      }
    } catch (e) {
      localStorage.removeItem("token");
      localStorage.removeItem("user");
      window.location.href = "/login";
      return;
    }
  });

  function addTextBlock() {
    const html = `<div class="mb-4 p-4 border border-border rounded-lg" id="block${blockCount}"><div class="flex justify-between mb-2"><span class="text-sm font-medium">Text Block</span><button type="button" onclick="removeBlock(${blockCount})" class="text-error text-sm">Remove</button></div><textarea class="w-full px-4 py-3 border border-border rounded-lg resize-none" rows="4" data-block-type="text" data-block-id="${blockCount}" placeholder="Write your content..."></textarea></div>`;
    document
      .getElementById("contentBlocks")
      .insertAdjacentHTML("beforeend", html);
    blockCount++;
  }

  function addImageBlock() {
    const html = `<div class="mb-4 p-4 border border-border rounded-lg" id="block${blockCount}"><div class="flex justify-between mb-2"><span class="text-sm font-medium">Image Block</span><button type="button" onclick="removeBlock(${blockCount})" class="text-error text-sm">Remove</button></div><input type="file" accept="image/*" class="w-full px-4 py-3 border border-border rounded-lg mb-2" data-block-type="image" data-block-id="${blockCount}"><input type="text" class="w-full px-4 py-3 border border-border rounded-lg" data-caption="${blockCount}" placeholder="Image caption (optional)"></div>`;
    document
      .getElementById("contentBlocks")
      .insertAdjacentHTML("beforeend", html);
    blockCount++;
  }

  function removeBlock(id) {
    document.getElementById(`block${id}`).remove();
  }

  document
    .getElementById("createForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const btn = document.getElementById("submitBtn");
      const submitText = document.getElementById("submitText");
      const loadingText = document.getElementById("loadingText");

      btn.disabled = true;
      submitText.classList.add("hidden");
      loadingText.classList.remove("hidden");

      const formData = new FormData();
      formData.append("title", document.getElementById("title").value);
      formData.append("subtitle", document.getElementById("subtitle").value);

      const blocks = document.querySelectorAll("[data-block-type]");
      let blockIndex = 0;

      for (const block of blocks) {
        const type = block.getAttribute("data-block-type");
        formData.append(`block_type_${blockIndex}`, type);

        if (type === "text") {
          formData.append(`text_${blockIndex}`, block.value);
        } else if (type === "image" && block.files[0]) {
          formData.append(`image_${blockIndex}`, block.files[0]);
          const caption = document.querySelector(
            `[data-caption="${block.getAttribute("data-block-id")}"]`,
          );
          if (caption) formData.append(`caption_${blockIndex}`, caption.value);
        }
        blockIndex++;
      }

      try {
        const token = localStorage.getItem("token");
        const response = await fetch("/api/posts", {
          method: "POST",
          headers: { Authorization: `Bearer ${token}` },
          body: formData,
        });

        const data = await response.json();
        if (data.success) {
          showToast("Post published!", "success");
          setTimeout(() => (window.location.href = "/admin/dashboard"), 1000);
        } else {
          showToast(data.error || "Failed to publish", "error");
          btn.disabled = false;
          submitText.classList.remove("hidden");
          loadingText.classList.add("hidden");
        }
      } catch (error) {
        console.error("Error:", error);
        showToast("An error occurred", "error");
        btn.disabled = false;
        submitText.classList.remove("hidden");
        loadingText.classList.add("hidden");
      }
    });
</script>
{% endblock %}
